# 2.4 Formularios: La Puerta de Entrada de Datos

## Introducci√≥n

Los formularios son la √∫nica forma en que el usuario puede *hablar* con el servidor.
Son el componente m√°s complejo y cr√≠tico de HTML. Un formulario mal hecho te cuesta dinero (ventas perdidas).

---

## La Etiqueta `<form>`
El contenedor de todos los inputs.
```html
<form action="/login" method="POST">
    <!-- Tus inputs van aqu√≠ -->
</form>
```
*   **GET:** Para buscar cosas (los datos van en la URL).
*   **POST:** Para enviar datos privados (contrase√±as).

---

## Tipos de Input Cl√°sicos

Estos existen desde los 90s y funcionan hasta en una tostadora.

### Tipos de Input comunes
*   **`text`:** Texto normal.
*   **`password`:** Oculta lo que escribes.
*   **`email`:** Valida que sea un correo.
*   **`number`:** Solo permite n√∫meros.
*   **`checkbox`:** Casilla de selecci√≥n m√∫ltiple.
*   **`radio`:** Selecci√≥n √∫nica (solo una opci√≥n).

---

## Etiquetas de UX y Accesibilidad

Un input sin label es inaccesible.

### `<label>`
Vincula un texto con un input. Al hacer clic en el texto, se activa el input.
```html
<label for="nombre">Tu Nombre:</label>
<input id="nombre" type="text">
```
*   *Alternativa:* Anidar el input dentro del label. `<label>Nombre <input></label>`.

### `<fieldset>` y `<legend>`
Agrupa inputs relacionados visual y sem√°nticamente.
```html
<fieldset>
    <legend>Datos de Env√≠o</legend>
    <input type="text" placeholder="Calle">
    <input type="text" placeholder="Ciudad">
</fieldset>
```

### `<datalist>` (Autocompletado)
Como un `<select>`, pero permite escribir algo nuevo.
```html
<input list="sabores">
<datalist id="sabores">
    <option value="Vainilla">
    <option value="Chocolate">
    <option value="Fresa">
</datalist>
```

---

## Atributos de Validaci√≥n y Comportamiento

HTML5 valida por ti sin una sola l√≠nea de JS.

### Validaci√≥n Autom√°tica
HTML5 puede validar los datos sin que escribas JavaScript.
*   `required`: Obligatorio.
*   `min="18"`: Valor m√≠nimo num√©rico.
*   `minlength="5"`: M√≠nimo de letras.
*   `placeholder`: Texto de ayuda gris.

---

## API de Validaci√≥n de Restricciones (Constraint Validation API)

El HTML dice "Este campo es requerido", pero el navegador muestra una burbuja fea y gen√©rica: "Please fill out this field".
Con JavaScript podemos personalizar esto usando la API nativa.

### M√©todos y Propiedades
Todo input tiene estas propiedades en JS:
*   `validity`: Un objeto con el estado del error (`validity.valueMissing`, `validity.typeMismatch`, `validity.tooShort`).
*   `validationMessage`: El mensaje de error actual.
*   `checkValidity()`: Devuelve `true` si es v√°lido.
*   `setCustomValidity("Mensaje")`: Define un error personalizado.

### Ejemplo: Personalizando el Mensaje
```javascript
const emailInput = document.getElementById('email');

emailInput.addEventListener('input', (event) => {
  if (emailInput.validity.typeMismatch) {
    emailInput.setCustomValidity('¬°Oye! Eso no parece un correo real (falta el @).');
  } else {
    emailInput.setCustomValidity(''); // String vac√≠o significa "V√°lido"
  }
});
```

---

## Estilizando Formularios con CSS (Pseudo-clases)

Olv√≠date de agregar y quitar clases como `.error` manualmente. CSS tiene estados nativos.

### Estados de Validaci√≥n
*   `:valid`: El input cumple las reglas. (P√≠ntalo verde).
*   `:invalid`: El input tiene errores. (P√≠ntalo rojo).
    *   *Nota:* Se activa desde que carga la p√°gina. Para evitar mostrar errores en campos vac√≠os, usa `:placeholder-shown` o JS.
*   `:required`: Campos obligatorios (puedes ponerles un asterisco `*` con `::after`).
*   `:optional`: Campos opcionales.

### Estados de Interacci√≥n
*   `:focus`: Cuando el usuario est√° escribiendo.
*   `:focus-visible`: Solo cuando navega con teclado (anillo azul).
*   `:disabled`: Inputs desactivados.
*   `:read-only`: Inputs que no se pueden editar pero s√≠ leer y copiar.

### El Truco del Label Flotante (Material Design)
Usando `:placeholder-shown` y `+` (selector adyacente sibling).

```css
input:not(:placeholder-shown) + label,
input:focus + label {
    transform: translateY(-20px);
    font-size: 12px;
    color: blue;
}
```

---

## Seguridad en Formularios: Protegiendo al Usuario

Los formularios son el vector de ataque #1.

### Seguridad B√°sica
*   **CSRF:** Protege contra env√≠o de formularios falsos desde otros sitios.
*   **XSS:** Nunca imprimas lo que el usuario escribi√≥ sin "limpiarlo" antes.
*   **Captcha:** Evita que los robots llenen tu formulario.

---

## Subida de Archivos Avanzada (`<input type="file">`)

El input de archivo por defecto es horrible ("Seleccionar archivo" gris).
No se puede estilar directamente.

### El Hack del Label
Oculta el input real y estila el label conectado a √©l.

```html
<input type="file" id="mi-archivo" class="input-file" hidden>
<label for="mi-archivo" class="btn-subir">
    üìÇ Subir CV
</label>
```
Al hacer clic en el label, el navegador dispara el click en el input oculto.

### Drag and Drop API
Para arrastrar archivos a la zona.
Requiere JS avanzado (`dragover`, `drop`, `DataTransfer`), pero mejora la UX infinitamente.

### Previsualizaci√≥n de Imagen
Muestra la foto antes de subirla al servidor.
```javascript
input.onchange = evt => {
    const [file] = input.files;
    if (file) {
        previewImg.src = URL.createObjectURL(file);
    }
}
```

---

## Accesibilidad en Formularios (WAI-ARIA)

Crear formularios accesibles es ley (literalmente en muchos pa√≠ses).

### Errores Accesibles
No basta con poner el borde rojo. Un ciego no ve el borde rojo.
Tienes que *vincular* el mensaje de error con el input.

```html
<label for="email">Email:</label>
<input type="email" id="email" aria-describedby="email-error" aria-invalid="true">

<span id="email-error" class="error">El correo es inv√°lido.</span>
```
Cuando el input tenga foco, el lector dir√°: *"Email, entrada de texto inv√°lida. El correo es inv√°lido."*

### Grupos de Checkboxes
Usa `<fieldset>` y `<legend>` siempre.
```html
<fieldset>
    <legend>Elige tus ingredientes:</legend>
    <label><input type="checkbox"> Queso</label>
    <label><input type="checkbox"> Jam√≥n</label>
</fieldset>
```
Sin esto, el lector solo dice "Checkbox, Queso". Con esto dice "Elige tus ingredientes: Checkbox, Queso".

---

## Laboratorio de C√≥digo: Formulario de Registro Profesional

Vamos a crear un formulario que combina todo lo aprendido: Sem√°ntica, Accesibilidad, Seguridad (Token) y UX.

```html
<form action="/register" method="POST" class="form-registro" novalidate>
    <!-- Protecci√≥n CSRF -->
    <input type="hidden" name="csrf_token" value="abc-123-xyz">
    
    <h2>Crear Cuenta</h2>

    <!-- Grupo: Datos Personales -->
    <fieldset>
        <legend>Datos Personales</legend>
        
        <div class="form-group">
            <label for="username">Usuario:</label>
            <input type="text" id="username" name="username" 
                   required minlength="3" autocomplete="username"
                   aria-describedby="user-help">
            <small id="user-help">M√≠nimo 3 letras, sin espacios.</small>
        </div>

        <div class="form-group">
            <label for="email">Correo:</label>
            <input type="email" id="email" name="email" 
                   required autocomplete="email">
        </div>
    </fieldset>

    <!-- Grupo: Seguridad -->
    <fieldset>
        <legend>Seguridad</legend>
        
        <div class="form-group">
            <label for="pass">Contrase√±a:</label>
            <input type="password" id="pass" name="password" 
                   required minlength="8" autocomplete="new-password">
        </div>
    </fieldset>

    <!-- T√©rminos -->
    <div class="form-check">
        <input type="checkbox" id="terms" name="terms" required>
        <label for="terms">Acepto los <a href="/terms">T√©rminos y Condiciones</a></label>
    </div>

    <button type="submit" class="btn-primary">Registrarme</button>
</form>
```

> **üíª C√≥digo en Acci√≥n:**
> Un formulario real tiene validaci√≥n, accesibilidad y seguridad.
>
> üìÑ **Ver c√≥digo:** [03_login_profesional.html](codigos/03_login_profesional.html)
> (Pru√©balo: Intenta enviar el formulario vac√≠o).

---

## Glosario de Formularios

*   **Autofill:** Cuando el navegador rellena el formulario por ti (ej. tu direcci√≥n).
*   **Blob:** Binary Large Object. Representaci√≥n de un archivo en memoria JS.
*   **Controles de Formulario:** Inputs, selects, textareas, botones.
*   **Multipart/form-data:** El tipo de codificaci√≥n necesario para subir archivos binarios (fotos, pdfs).
*   **Placeholder:** Texto de ayuda temporal. NO reemplaza al label.
*   **Query String:** La parte de la URL despu√©s del `?` (`?q=gatos`).
*   **Submit:** La acci√≥n de enviar el formulario al servidor.
*   **Validation Bubble:** El mensaje nativo del navegador ("Rellene este campo").

---

## Retos para el Alumno

### Reto 1: "Validaci√≥n en Tiempo Real"
Usa JavaScript para que, mientras el usuario escribe su contrase√±a, aparezcan 3 palomitas (‚úÖ) si cumple:
1.  M√°s de 8 caracteres.
2.  Tiene una may√∫scula.
3.  Tiene un n√∫mero.

### Reto 2: "El Formulario Invisible"
Crea un formulario que use el atributo `hidden` en un input.
Haz un bot√≥n que, al ser clickeado, revele ese input.
*   *Caso de uso:* "Seleccione 'Otros'..." -> Aparece campo "¬øCu√°l?".

### Reto 3: "Input Estilizado"
Qu√≠tale todos los estilos por defecto a un input (`border: none`, `outline: none`) y redis√©√±alo para que solo tenga una l√≠nea inferior animada de color rosa cuando tenga foco.

---

## Expresiones Regulares (Regex): Validaci√≥n Nivel Dios

El atributo `pattern` usa Regex. Es un lenguaje cr√≠ptico pero poderoso.

### Chuleta B√°sica
*   `^`: Inicio de l√≠nea.
*   `$`: Fin de l√≠nea.
*   `[a-z]`: Cualquier letra min√∫scula.
*   `[0-9]` o `\d`: Cualquier n√∫mero.
*   `{3}`: Exactamente 3 veces.
*   `{3,}`: 3 o m√°s veces.
*   `+`: Una o m√°s veces.
*   `*`: Cero o m√°s veces (Cuidado, acepta cadenas vac√≠as).

### Recetario Mexicano (RFC y CURP)

**RFC (Persona F√≠sica):** 4 letras, 6 n√∫meros, 3 homoclave.
`pattern="^[A-Z&√ë]{4}\d{6}[A-Z0-9]{3}$"`
*   Explicaci√≥n:
    *   `^[A-Z&√ë]{4}`: Empieza con 4 letras may√∫sculas (incluye √ë y &).
    *   `\d{6}`: Sigue con 6 d√≠gitos (Fecha YYMMDD).
    *   `[A-Z0-9]{3}$`: Termina con 3 caracteres alfanum√©ricos.

**CURP:** 4 letras, 6 n√∫meros, 1 letra (H/M), 5 letras (Estado/Consonantes), 2 d√≠gitos.
`pattern="^[A-Z]{4}\d{6}[HM][A-Z]{5}[A-Z0-9]{2}$"`

### Contrase√±a Segura
M√≠nimo 8 caracteres, 1 may√∫scula, 1 min√∫scula, 1 n√∫mero.
`pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}"`
*   Usa "Lookaheads" `(?=...)` para verificar condiciones m√∫ltiples en cualquier orden.

---

## Patrones de Dise√±o de Formularios (UX)

No basta con que funcione. Tiene que ser f√°cil de usar.

### Wizard (Pasos M√∫ltiples)
Si tienes 50 campos, no los muestres todos de golpe. Divide y vencer√°s.
1.  **Paso 1:** Datos de Cuenta.
2.  **Paso 2:** Direcci√≥n.
3.  **Paso 3:** Pago.
*   *Implementaci√≥n:* Usa 3 `<fieldset>` y oculta 2 con CSS/JS. Muestra una barra de progreso.

### Inline Validation (Validaci√≥n en L√≠nea)
*   **Mal:** El usuario llena 20 campos, le da "Enviar", y la p√°gina recarga con 5 errores arriba.
*   **Bien (On Blur):** Cuando el usuario *sale* de un campo (`blur`), val√≠dalo y muestra el error ah√≠ mismo.
*   **Mejor (On Input - con debounce):** Validar mientras escribe (ej. fortaleza de contrase√±a), pero esperar a que termine de escribir para errores de formato (email).

### Floating Labels (Material Design)
El label est√° dentro del input (como placeholder). Al hacer click, flota hacia arriba y se hace peque√±o.
*   *Ventaja:* Ahorra espacio vertical en m√≥viles.
*   *Desventaja:* Si no est√° bien hecho, se confunde con el valor ya escrito.

---

---

## La API `FormData` y el Env√≠o sin Recarga (AJAX)

En la web moderna (SPAs), no queremos que la p√°gina parpadee al enviar. Usamos JS.

### Interceptando el Env√≠o
```javascript
const form = document.querySelector('form');

form.addEventListener('submit', (e) => {
    e.preventDefault(); // 1. Detiene la recarga
    
    // 2. Captura los datos m√°gicamente
    const data = new FormData(form);
    
    // 3. Imprime los valores
    console.log(data.get('username'));
    console.log(Object.fromEntries(data)); // Convierte a JSON simple
});
```

### Enviando al Servidor (Fetch API)
```javascript
fetch('/api/register', {
    method: 'POST',
    body: new FormData(form) // El navegador pone el Content-Type correcto autom√°ticamente
})
.then(response => response.json())
.then(data => alert('¬°Guardado!'));
```

---

## Estilizando lo "In-estilizable"

Checkboxes y Radios nativos son feos y diferentes en cada navegador.
La t√©cnica moderna para personalizar ckeckboxes:

```css
/* 1. Ocultar el input nativo (pero mantenerlo accesible) */
input[type="checkbox"] {
    appearance: none; /* Resetea el estilo nativo */
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border: 2px solid gray;
    border-radius: 4px;
    cursor: pointer;
    display: grid;
    place-content: center;
}

/* 2. El estado checked */
input[type="checkbox"]:checked {
    background-color: blue;
    border-color: blue;
}

/* 3. La palomita (usando pseudo-elemento) */
input[type="checkbox"]::before {
    content: "‚úî";
    color: white;
    font-size: 14px;
    transform: scale(0); /* Oculto por defecto */
    transition: 120ms transform;
}

input[type="checkbox"]:checked::before {
    transform: scale(1); /* Visible */
}
```

---

## Accesibilidad Profunda en Formularios

### `aria-live` y `role="alert"`
Cuando aparece un error din√°micamente con JS, el lector de pantalla NO lo lee autom√°ticamente a menos que le avises.

```html
<div role="alert" aria-live="polite">
    <!-- Si JS inyecta texto aqu√≠, el lector lo dir√° inmediatamente -->
</div>
```
*   `polite`: Espera a que el usuario termine de hablar/escribir.
*   `assertive`: Interrumpe al usuario (√ösalo solo para errores cr√≠ticos).

### Cambios de Contexto
Nunca hagas que un formulario se env√≠e autom√°ticamente al seleccionar una opci√≥n en un `<select>` (`onchange="submit()"`).
Esto desorienta terriblemente a los usuarios de teclado. Siempre requiere un bot√≥n expl√≠cito "Enviar" o "Aplicar filtros".

---

## Auditor√≠a de Seguridad: Errores Comunes

### Confiar en la Validaci√≥n Frontend
**Mito:** "Si pongo `min="18"` en el input de edad, nadie menor de 18 entrar√°".
**Realidad:** Yo puedo abrir la consola, borrar `min="18"`, o enviar una petici√≥n `curl` directa al servidor con `age=5`.
**Regla:** La validaci√≥n HTML/JS es cosm√©tica. La validaci√≥n REAL est√° en el Servidor (PHP, Node, Java).

### Exponer IDs en Inputs Ocultos
`<input type="hidden" name="user_id" value="admin">`
Si veo esto, lo cambiar√© a `value="superadmin"`. Nunca conf√≠es en datos que "vienen de vuelta" del cliente.

---

## Recursos Avanzados

*   **HTML5 Pattern:** Una colecci√≥n de Regex listos para copiar y pegar.
*   **WAI-ARIA Authoring Practices:** Patrones oficiales de accesibilidad.
*   **OWASP Cheat Sheet:** Gu√≠a de seguridad para validaci√≥n de inputs.
*   **Can I Use:** Para verificar soporte de nuevos tipos de inputs (`input type="month"`, etc).

---

---

## Proyecto Final: E-commerce Checkout (Nivel Experto)

Vamos a armar un formulario de pago que cumpla con TODOS los est√°ndares de 2025.

### Estructura HTML
```html
<form class="checkout-form" action="/pay" method="POST">
    
    <!-- Progreso Sem√°ntico -->
    <nav aria-label="Progreso de compra">
        <ol class="steps">
            <li class="completed">Carrito</li>
            <li aria-current="step">Pago</li>
            <li>Confirmaci√≥n</li>
        </ol>
    </nav>

    <!-- Secci√≥n 1: Tarjeta de Cr√©dito -->
    <fieldset class="payment-group">
        <legend>Datos de Pago</legend>
        
        <div class="row">
            <div class="col-full">
                <label for="cc-name">Nombre en la tarjeta</label>
                <input type="text" id="cc-name" name="cc-name" 
                       required autocomplete="cc-name"
                       pattern="[A-Za-z ]{4,}"
                       placeholder="JESUS OLVERA">
            </div>
            
            <div class="col-full">
                <label for="cc-number">N√∫mero de tarjeta</label>
                <input type="text" id="cc-number" name="cc-number" 
                       required autocomplete="cc-number"
                       inputmode="numeric" 
                       pattern="[0-9\s]{13,19}"
                       placeholder="0000 0000 0000 0000">
                <!-- Icono de tarjeta detectado v√≠a JS -->
                <span id="cc-brand" aria-hidden="true"></span>
            </div>
            
            <div class="col-half">
                <label for="cc-exp">Expiraci√≥n (MM/YY)</label>
                <input type="text" id="cc-exp" name="cc-exp" 
                       required autocomplete="cc-exp"
                       placeholder="MM/YY"
                       pattern="(0[1-9]|1[0-2])\/?([0-9]{2})">
            </div>
            
            <div class="col-half">
                <label for="cc-cvc">CVC</label>
                <input type="text" id="cc-cvc" name="cc-cvc" 
                       required autocomplete="cc-csc"
                       inputmode="numeric" 
                       pattern="[0-9]{3,4}"
                       maxlength="4">
                <button type="button" aria-label="¬øQu√© es el CVC?" onclick="showHelp()">?</button>
            </div>
        </div>
    </fieldset>

    <!-- Secci√≥n 2: Direcci√≥n (Reutilizando datos) -->
    <fieldset>
        <legend>Direcci√≥n de Facturaci√≥n</legend>
        <label class="checkbox-wrapper">
            <input type="checkbox" name="same-address" checked onchange="toggleAddress()">
            Usar la misma direcci√≥n de env√≠o
        </label>
        
        <div id="billing-fields" hidden>
            <!-- Campos extra aqu√≠ -->
            <label for="street">Calle:</label>
            <input type="text" id="street" name="street" autocomplete="street-address">
        </div>
    </fieldset>

    <div class="actions">
        <!-- Prevent Double Submit -->
        <button type="submit" id="btn-pay">Pagar $1,200.00 MXN</button>
    </div>
</form>
```

### Notas de Ingenier√≠a
1.  **`autocomplete` es ORO:** Usamos `cc-name`, `cc-number`, `cc-exp`. Esto permite que Chrome/Safari rellenen la tarjeta con un clic (incluido FaceID).
2.  **`inputmode="numeric"`:** En iPhone, abre el teclado de n√∫meros grandes (tel√©fono), pero permite caracteres especiales (espacios). Es mejor que `type="number"` para tarjetas.
3.  **Accesibilidad:** Usamos `<nav aria-label>` para los pasos y `aria-hidden` para adornos visuales.

---

## Depuraci√≥n: Herramientas del Navegador

¬øC√≥mo sabes qu√© diablos se envi√≥ al servidor?

1.  Abre DevTools (F12) -> Pesta√±a **Network**.
2.  Activa la casilla **"Preserve Log"** (Importante, si no, al recargar se borra todo).
3.  Env√≠a el formulario.
4.  Busca la petici√≥n (usualmente el nombre del archivo del `action` o la √∫ltima en la lista).
5.  Ve a la pesta√±a **Payload** (o Params).
    *   Ah√≠ ver√°s el JSON o el Form Data decodificado. Si ves `[object Object]`, tu JS est√° mal.

---

## El Futuro de los Formularios: `inert` y `popover`

HTML sigue evolucionando.

### Atributo `inert`
Cuando abres un modal de "Confirmar Pago", el resto del formulario debe quedar congelado (no clicable, no tabulable).
Antes: `pointer-events: none` + JS complejo.
Ahora:
```html
<form inert>
   <!-- Todo esto est√° congelado y fuera del √°rbol de accesibilidad -->
</form>
```

### API Popover (2024)
Para los tooltips de ayuda ("¬øQu√© es el CVC?").
```html
<button popovertarget="help-cvc">¬øAyuda?</button>

<div id="help-cvc" popover>
  El CVC son los 3 n√∫meros al reverso...
</div>
```
*   Sin una sola l√≠nea de JS. Nativo.

---

<div align="center">

[‚¨ÖÔ∏è Anterior: 2.3 Elementos B√°sicos](2.3.md) &nbsp;&nbsp;|&nbsp;&nbsp; [Siguiente: 2.5 Lenguajes de Presentaci√≥n](2.5.md) ‚û°Ô∏è

</div>

