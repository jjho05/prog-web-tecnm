# 3.4 Manipulaci칩n de Objetos (DOM & APIs)

JavaScript sin objetos no sirve de nada.
Aqu칤 aprender치s a manipular el navegador, la memoria y los datos.

---

### Selectores Modernos (`querySelector`)
Ya no uses `getElementById`. Usa selectores CSS:
*   `document.querySelector('.clase')`: Selecciona el **primero**.
*   `document.querySelectorAll('div')`: Selecciona **todos** (retorna una lista).

### Manipular Elementos
*   **Texto:** `elemento.textContent = "Nuevo Texto"`.
*   **Estilos:** `elemento.style.color = "red"` (Mejor usa clases).
*   **Clases:** `elemento.classList.add('active')` / `.remove('error')`.
*   **Datos:** `<div data-id="5">` -> `elemento.dataset.id`.

> **游눹 C칩digo en Acci칩n:**
> Copia y pega este script en la consola de tu navegador para ver c칩mo el DOM cambia en tiempo real.
>
> 游늯 **Ver c칩digo:** [03_dom_manipulation.js](codigos/03_dom_manipulation.js)

---

## Traversing (Navegando el 츼rbol)

A veces tienes el elemento Hijo y quieres llegar al Abuelo.

### Hacia Arriba (`closest`)
El m칠todo m치s 칰til y menos conocido. Busca el ancestro m치s cercano que cumpla el selector.
```javascript
// Imagina un click en un icono dentro de un bot칩n dentro de un form
e.target.closest('form'); // Encuentra el formulario, subiendo por el 치rbol
```

### Hacia los Lados y Abajo
*   `el.children`: Hijos directos (HTMLCollection).
*   `el.nextElementSibling`: El siguiente hermano (`div` -> `span`).
*   `el.parentElement`: El padre directo.

---

## Creaci칩n Eficiente (Evita el Reflow)

Si vas a crear 100 `<li>`, no los insertes uno por uno. El navegador repintar치 100 veces.

### `DocumentFragment` (El DOM Fantasma)
Un contenedor que no est치 en la pantalla.
```javascript
const fragmento = document.createDocumentFragment();

for (let i = 0; i < 100; i++) {
    const li = document.createElement('li');
    li.textContent = `Item ${i}`;
    fragmento.appendChild(li); // Memoria (R치pido)
}

document.ul.appendChild(fragmento); // Pantalla (1 solo Repaint)
```

---

### Eventos (`addEventListener`)
Nunca uses `onclick=""` en el HTML. Ensucia y es limitado.
```javascript
boton.addEventListener('click', (evento) => {
    console.log("Diste click!", evento.target);
});
```

### Delegaci칩n de Eventos
Si tienes una lista con 100 items, **no pongas 100 listeners**.
Pon 1 listener en el padre y detecta qui칠n fue clickeado:
```javascript
ul.addEventListener('click', (e) => {
    if (e.target.matches('li')) {
        console.log("Click en un item de la lista");
    }
});
```
Es m치s eficiente y funciona aunque agregues items nuevos despu칠s.

---

---

## Propagaci칩n de Eventos (Bubbling y Capturing)

Cuando haces clic en un bot칩n, no solo haces clic en 칠l. Haces clic en su padre, en el body, y en el html.

### Fases del Evento
1.  **Capturing (Bajada):** Desde el `window` hasta el elemento. (Raramente usado).
2.  **Target:** El evento llega al elemento.
3.  **Bubbling (Subida):** Desde el elemento hasta el `window`. (Aqu칤 funciona el Event Delegation).

### Controlando el Flujo
*   `e.stopPropagation()`: *"Detente aqu칤. No avises a mis padres."*
    *   **Peligro:** Puede romper Analytics o tooltips que dependen de escuchar clicks en el body.
*   `e.preventDefault()`: *"No hagas tu acci칩n por defecto."*
    *   Evita que un Form se env칤e y recargue.
    *   Evita que un Link navegue.

---

### Objetos: M치s all치 del punto
*   `Object.keys(obj)`: Dame un array con las claves.
*   `Object.values(obj)`: Dame los valores.
*   `Object.assign({}, obj)`: Clona un objeto (o usa `{...obj}`).
*   `Object.freeze(obj)`: Congela el objeto para que nadie lo cambie.

---

## JSON (JavaScript Object Notation)

El lenguaje universal de intercambio de datos.

### Serializaci칩n (`JSON.stringify`)
Convierte Objeto -> Texto.
```javascript
const data = { id: 1, date: new Date() };
const json = JSON.stringify(data);
// '{"id":1, "date":"2025-01-26T..."}'
```
*   **Truco:** `JSON.stringify(obj, null, 2)` formatea el JSON bonito con indentaci칩n.

### Deserializaci칩n (`JSON.parse`)
Convierte Texto -> Objeto.
```javascript
const obj = JSON.parse(json);
// OJO: Las fechas vuelven como STRING, no como Date Objects.
```

### Deep Clone Hack
La forma m치s barata de clonar un objeto complejo (perdiendo fechas y funciones).
```javascript
const clon = JSON.parse(JSON.stringify(original));
```
*   **2025 Standard:** Usa `structuredClone(original)` que s칤 soporta Fechas y Mapas.

---

---

### Guardar Datos (`LocalStorage`)
Ideal para guardar configuraci칩n (tema oscuro, sesi칩n).
*   `localStorage.setItem('clave', 'valor')`: Guardar.
*   `localStorage.getItem('clave')`: Leer.
*   **Nota:** Solo guarda Texto. Si quieres guardar objetos, usa `JSON.stringify(obj)` antes y `JSON.parse(txt)` al leer.

*   **SessionStorage:** Igual, pero se borra al cerrar la pesta침a.
*   **Cookies:** 칔salas solo para enviar Tokens al servidor de forma segura.

---

### Llamadas a Servidor (`fetch`)
La forma moderna de AJAX. Es una Promesa.

**GET (Pedir datos):**
```javascript
const respuesta = await fetch('/api/usuarios');
const datos = await respuesta.json();
console.log(datos);
```

**POST (Enviar datos):**
```javascript
await fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ email: 'test@test.com' })
});
```

---

## Programaci칩n Orientada a Objetos (POO)

Aunque uses React, entender Clases es vital para saber c칩mo funciona JS por dentro.

### Syntactic Sugar (`class`)
Antes us치bamos funciones y prototipos manualmente. Ahora:
```javascript
class Animal {
    constructor(nombre) {
        this.nombre = nombre;
    }
    
    hablar() {
        console.log(`${this.nombre} hace ruido.`);
    }
}

class Perro extends Animal {
    hablar() {
        super.hablar(); // Llama al padre
        console.log("Guau!");
    }
}

const firulais = new Perro("Firulais");
firulais.hablar(); // "Firulais hace ruido. Guau!"
```
*   **Secreto:** `typeof Animal` sigue siendo `'function'`. Es az칰car sobre Prototipos.

### Campos Privados (ECMAScript 2022)
Usando `#` al inicio.
```javascript
class CuentaBancaria {
    #saldo = 0; // Privado real

    depositar(cantidad) {
        this.#saldo += cantidad;
    }
    
    // No puedes acceder a banco.#saldo desde fuera
}
```

---

---

## El BOM (Browser Object Model)

El DOM es la p치gina (`document`). El BOM es el navegador (`window`).

### `navigator` (Informaci칩n del Cliente)
쯈ui칠n es el usuario?
```javascript
// Hardware
console.log(navigator.userAgent); // Tipo de navegador
console.log(navigator.language); // "es-MX"
console.log(navigator.onLine); // true/false (쯊iene internet?)
console.log(navigator.clipboard); // Portapapeles API
```
*   **Geolocalizaci칩n:**
    ```javascript
    navigator.geolocation.getCurrentPosition(pos => {
        console.log(pos.coords.latitude);
    });
    ```

### `location` (La URL actual)
Controla la barra de direcciones.
```javascript
console.log(location.href); // URL completa
console.log(location.pathname); // "/ruta/actual"

// Redireccionar
location.href = "https://google.com"; // Guarda historial
location.replace("https://google.com"); // NO guarda historial (칰til tras Logout)
```

### `history` (SPA Navigation)
Manipular el historial sin recargar.
```javascript
history.pushState({ id: 1 }, "Titulo", "/nuevo-link");
history.back(); // Volver atr치s
```

---

## Manejo de Fechas y Moneda (`Intl`)

`Date` es horrible. `Intl` es la soluci칩n nativa moderna para formatear.

### Fechas (`Intl.DateTimeFormat`)
```javascript
const fecha = new Date();
const formato = new Intl.DateTimeFormat('es-MX', {
    dateStyle: 'full',
    timeStyle: 'short'
}).format(fecha);

console.log(formato); 
// "domingo, 26 de enero de 2025, 10:30 p.m."
```

### Monedas (`Intl.NumberFormat`)
Nunca formatees dinero a mano (`"$" + valor`). Rompe en otros pa칤ses.
```javascript
const precio = 1234.56;
const pesos = new Intl.NumberFormat('es-MX', {
    style: 'currency',
    currency: 'MXN'
}).format(precio);

console.log(pesos); // "$1,234.56"
```

### Tiempos Relativos
```javascript
const rtf = new Intl.RelativeTimeFormat('es', { numeric: 'auto' });
console.log(rtf.format(-1, 'day')); // "ayer"
console.log(rtf.format(2, 'minute')); // "dentro de 2 minutos"
```

---

## Web Workers (Multithreading Real)

JS es Single Threaded. Si haces un c치lculo pesado (procesar imagen, encriptar), la UI se congela.
Soluci칩n: Moverlo a otro hilo.

### `worker.js` (El otro hilo)
Este archivo corre separado. No tiene acceso al DOM (`window`, `document` no existen).
```javascript
// worker.js
self.onmessage = (e) => {
    // C치lculo pesado
    let suma = 0;
    for (let i = 0; i < 1e9; i++) suma += i;
    
    // Devolver resultado
    self.postMessage(suma);
};
```

### `main.js` (El hilo principal)
```javascript
const worker = new Worker('worker.js');

worker.postMessage('start'); // Iniciar

worker.onmessage = (e) => {
    console.log("C치lculo terminado:", e.data);
    // La UI nunca se congel칩
};
```

---

---

## Intersection Observer API (La Magia del Scroll)

Detectar cuando un elemento entra en la pantalla *sin* escuchar el evento `scroll` (que es lento).

### Lazy Loading de Im치genes
Cargar im치genes solo cuando el usuario las ve.
```javascript
const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const img = entry.target;
            img.src = img.dataset.src; // Cargar imagen real
            observer.unobserve(img); // Dejar de observar
        }
    });
});

document.querySelectorAll('img.lazy').forEach(img => observer.observe(img));
```

### Animaciones al Scrollear
```javascript
const animarEntrada = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            entry.target.classList.add('animate-fadeIn');
        }
    });
});
```

---

## Drag and Drop API (Nativo)

Crear interfaces tipo Trello sin librer칤as.

### Elementos Draggables
En el HTML: `<div draggable="true">Tarea 1</div>`

```javascript
const item = document.querySelector('[draggable]');

item.addEventListener('dragstart', (e) => {
    e.dataTransfer.setData('text/plain', e.target.id);
    e.target.classList.add('dragging');
});

item.addEventListener('dragend', (e) => {
    e.target.classList.remove('dragging');
});
```

### Zonas para Soltar (Drop Zones)
```javascript
const zona = document.querySelector('.drop-zone');

zona.addEventListener('dragover', (e) => {
    e.preventDefault(); // OBLIGATORIO para permitir soltar
});

zona.addEventListener('drop', (e) => {
    e.preventDefault();
    const id = e.dataTransfer.getData('text');
    const draggable = document.getElementById(id);
    zona.appendChild(draggable); // Mover elemento al nuevo padre
});
```

---

## Canvas API (Gr치ficos 2D)

Dibujar p칤xeles directamente.

### Contexto 2D
```html
<canvas id="lienzo" width="500" height="500"></canvas>
```
```javascript
const canvas = document.getElementById('lienzo');
const ctx = canvas.getContext('2d');

// Cuadrado Rojo
ctx.fillStyle = 'red';
ctx.fillRect(10, 10, 100, 100);

// Texto
ctx.font = '30px Arial';
ctx.fillStyle = 'black';
ctx.fillText("Hola Mundo", 50, 50);
```

### Animaciones (Game Loop)
Usar `requestAnimationFrame` en lugar de `setInterval`.
```javascript
function loop() {
    ctx.clearRect(0, 0, 500, 500); // Borrar anterior
    // Dibujar nuevo frame...
    requestAnimationFrame(loop);
}
loop();
```

---

---

## Depuraci칩n de Memoria y Rendimiento

El navegador consume mucha RAM. Aprende a diagnosticar por qu칠.

### Chrome DevTools: Memory Tab
1.  **Heap Snapshot:** Toma una "foto" de la memoria actual. Sirve para ver qu칠 objetos ocupan m치s espacio.
2.  **Allocation instrumentation on timeline:** Graba en tiempo real qui칠n est치 creando objetos.
3.  **B칰squeda de Detached Elements:** Si un elemento DOM fue borrado de la pantalla (remove) pero JS sigue teniendo referencia a 칠l, es un Memory Leak.
    *   **Soluci칩n:** `elemento = null` cuando ya no lo uses.

### WeakRef y FinalizationRegistry
Objetos que el Garbage Collector *s칤* puede borrar aunque los tengas en variables.
```javascript
let cache = new WeakMap();

function cachearUsuario(usuario) {
    cache.set(usuario, "Datos extra");
    // Si 'usuario' deja de usarse en la app, se borra de 'cache' autom치ticamente.
}
```

---

## Client-Side Security (Lo que un Senior sabe)

El backend no lo hace todo. El frontend es la primera l칤nea de defensa.

### Same-Origin Policy (SOP)
El navegador impide por defecto que `facebook.com` lea datos de `gmail.com`.
Solo puedes hacer peticiones a tu mismo dominio, a menos que el servidor active **CORS**.

### CSP (Content Security Policy)
Un header HTTP que dice: *"Solo permite ejecutar scripts de mi-dominio.com"*.
Evita que un hacker inyecte `<script src="hacker.com/robo.js">`.

### Vulnerabilidades Comunes
*   **XSS (Cross Site Scripting):** Inyectar JS en inputs.
    *   *Defensa:* Nunca uses `innerHTML` con datos de usuario. Escapa siempre los caracteres `< >`.
*   **Clickjacking:** Meter tu web en un `<iframe>` transparente para robar clicks.
    *   *Defensa:* Header `X-Frame-Options: DENY`.

---

---

## El Futuro de la Web (Lo que viene)

JS ya no est치 solo.

### WebAssembly (WASM)
Correr c칩digo de C++, Rust o Go en el navegador a velocidad nativa.
*   **Uso:** Figma, Photoshop Web, Edici칩n de Video.
*   **JS:** Sigue siendo el pegamento, pero la l칩gica pesada va a WASM.

### WebGPU
El reemplazo de WebGL. Acceso directo a la Tarjeta Gr치fica (GPU).
*   **Potencial:** Juegos AAA en el navegador, Machine Learning (TensorFlow.js) acelerado por hardware.

### Web Containers
Correr Node.js entero DENTRO del navegador (sin servidor).
As칤 funciona StackBlitz.

---

<div align="center">

[拘勇 Anterior: 3.3 Estructuras de Control](3.3.md) &nbsp;&nbsp;|&nbsp;&nbsp; [Siguiente: Unidad 4 (Pr칩ximamente)](../unidad4/README.md) 俱뫮잺

</div>
